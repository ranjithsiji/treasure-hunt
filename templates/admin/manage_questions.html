{% extends "admin/base_admin.html" %}

{% block title %}Manage Questions - {{ level.name }} - Treasure Hunt{% endblock %}

{% block content %}
<div class="page-header">
    <div class="d-flex justify-content-between align-items-center">
        <div>
            <h1><i class="bi bi-question-circle-fill"></i> Manage Questions - {{ level.name }}</h1>
            <p class="text-muted">Level {{ level.level_number }} Questions</p>
        </div>
        <div>
            <a href="{{ url_for('admin.add_question', level_id=level.id) }}" class="btn btn-primary btn-lg">
                <i class="bi bi-plus-circle"></i> Add New Question
            </a>
        </div>
    </div>
</div>

<div class="admin-card">
    <div class="admin-card-header">
        <div class="d-flex justify-content-between align-items-center">
            <div>
                <i class="bi bi-list-task"></i> Questions List
            </div>
            <div>
                <span class="badge bg-primary badge-custom">{{ questions|length }} Questions</span>
            </div>
        </div>
    </div>
    <div class="admin-card-body">
        {% if questions %}
        <div class="table-responsive">
            <table class="admin-table table">
                <thead>
                    <tr>
                        <th style="width: 80px;">Q#</th>
                        <th style="width: 120px;">Type</th>
                        <th>Question Text</th>
                        <th style="width: 150px;">Answer</th>
                        <th style="width: 100px;">Points</th>
                        <th style="width: 120px;">Media Files</th>
                        <th style="width: 100px;">Clues</th>
                        <th style="width: 200px;">Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for question in questions %}
                    <tr>
                        <td>
                            <span class="badge bg-primary badge-custom fs-6">{{ question.question_number }}</span>
                        </td>
                        <td>
                            {% if question.question_type == 'text' %}
                            <span class="badge bg-info badge-custom"><i class="bi bi-file-text"></i> Text</span>
                            {% elif question.question_type == 'image' %}
                            <span class="badge bg-success badge-custom"><i class="bi bi-image"></i> Image</span>
                            {% elif question.question_type == 'video' %}
                            <span class="badge bg-danger badge-custom"><i class="bi bi-camera-video"></i> Video</span>
                            {% elif question.question_type == 'mixed' %}
                            <span class="badge bg-warning badge-custom"><i class="bi bi-collection"></i> Mixed</span>
                            {% else %}
                            <span class="badge bg-secondary badge-custom">{{ question.question_type }}</span>
                            {% endif %}
                        </td>
                        <td>
                            <div class="question-preview">
                                {% if question.question_text|length > 100 %}
                                {{ question.question_text|striptags|truncate(100) }}
                                {% else %}
                                {{ question.question_text|striptags }}
                                {% endif %}
                            </div>
                        </td>
                        <td>
                            <code class="answer-preview">{{ question.answer }}</code>
                        </td>
                        <td>
                            <span class="badge bg-warning badge-custom">
                                <i class="bi bi-star-fill"></i> {{ question.points }}
                            </span>
                        </td>
                        <td>
                            {% if question.media_files|length > 0 %}
                            <span class="badge bg-success badge-custom">
                                <i class="bi bi-paperclip"></i> {{ question.media_files|length }} file(s)
                            </span>
                            {% else %}
                            <span class="badge bg-secondary badge-custom">No media</span>
                            {% endif %}
                        </td>
                        <td>
                            <span class="badge bg-info badge-custom">
                                <i class="bi bi-lightbulb"></i> {{ question.clues|length }}
                            </span>
                        </td>
                        <td>
                            <div class="action-btn-group">
                                <a href="{{ url_for('admin.edit_question', question_id=question.id) }}"
                                    class="btn btn-sm btn-warning action-btn" title="Edit Question">
                                    <i class="bi bi-pencil-square"></i>
                                </a>
                                <a href="{{ url_for('admin.manage_clues', question_id=question.id) }}"
                                    class="btn btn-sm btn-info action-btn" title="Manage Clues">
                                    <i class="bi bi-lightbulb"></i>
                                </a>
                                <form method="POST"
                                    action="{{ url_for('admin.delete_question', question_id=question.id) }}"
                                    style="display: inline;"
                                    onsubmit="return confirm('Are you sure you want to delete this question? This will also delete all associated clues and media files.');">
                                    <button type="submit" class="btn btn-sm btn-danger action-btn"
                                        title="Delete Question">
                                        <i class="bi bi-trash"></i>
                                    </button>
                                </form>
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>

        <!-- Summary Stats -->
        <div class="row mt-4">
            <div class="col-md-3">
                <div class="stat-box">
                    <div class="stat-icon bg-primary">
                        <i class="bi bi-question-circle"></i>
                    </div>
                    <div class="stat-details">
                        <h3>{{ questions|length }}</h3>
                        <p>Total Questions</p>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="stat-box">
                    <div class="stat-icon bg-success">
                        <i class="bi bi-paperclip"></i>
                    </div>
                    <div class="stat-details">
                        {% set total_media = namespace(count=0) %}
                        {% for question in questions %}
                        {% set total_media.count = total_media.count + question.media_files|length %}
                        {% endfor %}
                        <h3>{{ total_media.count }}</h3>
                        <p>Media Files</p>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="stat-box">
                    <div class="stat-icon bg-info">
                        <i class="bi bi-lightbulb"></i>
                    </div>
                    <div class="stat-details">
                        {% set total_clues = namespace(count=0) %}
                        {% for question in questions %}
                        {% set total_clues.count = total_clues.count + question.clues|length %}
                        {% endfor %}
                        <h3>{{ total_clues.count }}</h3>
                        <p>Total Clues</p>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="stat-box">
                    <div class="stat-icon bg-warning">
                        <i class="bi bi-star"></i>
                    </div>
                    <div class="stat-details">
                        <h3>{{ questions|sum(attribute='points') }}</h3>
                        <p>Total Points</p>
                    </div>
                </div>
            </div>
        </div>

        {% else %}
        <div class="empty-state">
            <i class="bi bi-question-circle"></i>
            <h3>No Questions Yet</h3>
            <p>Start by adding your first question for this level.</p>
            <a href="{{ url_for('admin.add_question', level_id=level.id) }}" class="btn btn-primary">
                <i class="bi bi-plus-circle"></i> Add First Question
            </a>
        </div>
        {% endif %}
    </div>
</div>

<div class="mt-3">
    <a href="{{ url_for('admin.manage_levels') }}" class="btn btn-secondary">
        <i class="bi bi-arrow-left"></i> Back to Levels
    </a>
</div>
{% endblock %}

{% block extra_css %}
<style>
    .question-preview {
        max-width: 400px;
        overflow: hidden;
        text-overflow: ellipsis;
    }

    .answer-preview {
        background: #f8f9fa;
        padding: 4px 8px;
        border-radius: 4px;
        font-size: 0.9em;
    }

    .stat-box {
        display: flex;
        align-items: center;
        padding: 1.5rem;
        background: white;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }

    .stat-icon {
        width: 60px;
        height: 60px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        margin-right: 1rem;
        color: white;
        font-size: 1.5rem;
    }

    .stat-details h3 {
        margin: 0;
        font-size: 2rem;
        font-weight: bold;
        color: #2c3e50;
    }

    .stat-details p {
        margin: 0;
        color: #7f8c8d;
        font-size: 0.9rem;
    }
</style>
{% endblock %}